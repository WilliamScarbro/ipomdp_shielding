# CartPole Case Study

This case study demonstrates **vision-based perception shielding** for the CartPole-v1 environment. A CNN estimates the 4D continuous state (position, velocity, pole angle, angular velocity) from consecutive frame pairs, and we build an IPOMDP to provide safety guarantees under perception uncertainty.

## Key Features

- **Configurable Discretization**: Support for uniform or non-uniform binning across dimensions
  - Default: 7 bins per dimension = 7^4 = 2,401 states
  - Recommended for LFP propagator: 5 bins = 625 states
  - Custom: e.g., [7, 5, 7, 5] for higher precision on position/angle
- **Vision-Based Perception**: CNN trained on frame pairs to estimate state
- **Factored Perception Model**: Independent perception models per dimension combined via product
- **Empirical Dynamics**: MDP learned from 10,000+ gymnasium rollouts
- **Safety**: Within CartPole-v1 termination bounds (|x| ≤ 2.4, |θ| ≤ 12°)

## Directory Structure

```
CartPole/
├── __init__.py                 # Public API exports
├── cartpole.py                 # Core model (states, dynamics, perception, safety, builder)
├── data_loader.py              # Load confusion matrices and bin edges
├── data_preparation.py         # Generate and save all data files
├── cartpole_model_test.py      # Validate perception bounds
├── README.md                   # This file
└── artifacts/                  # Data files (generated by data_preparation.py)
    ├── bin_edges.npy           # (4, 8) array of bin edges
    ├── x_confusion.npy         # (7, 7) confusion matrix
    ├── x_dot_confusion.npy     # (7, 7) confusion matrix
    ├── theta_confusion.npy     # (7, 7) confusion matrix
    ├── theta_dot_confusion.npy # (7, 7) confusion matrix
    ├── cartpole_state_net.pt   # Trained PyTorch model
    └── dynamics_mdp.pkl        # Empirical dynamics MDP
```

## Usage

### 1. Generate Data

First, generate the required data files by running:

```bash
python -m ipomdp_shielding.CaseStudies.CartPole.data_preparation
```

This will:
1. Collect frame pairs and states from CartPole-v1 (200 episodes)
2. Train a CNN to predict state from frames (20 epochs)
3. Generate confusion matrices for each state dimension
4. Collect empirical dynamics (10,000 episodes)
5. Save all data to `artifacts/` directory

**Note**: This requires `torch`, `torchvision`, and `gymnasium` to be installed.

### 2. Build IPOMDP

```python
from ipomdp_shielding.CaseStudies.CartPole import build_cartpole_ipomdp

# Build IPOMDP with default parameters
ipomdp, pp_shield, test_data = build_cartpole_ipomdp(
    confidence_method="Clopper_Pearson",
    alpha=0.05,
    train_fraction=0.8,
    num_bins=7,
    smoothing=True,
    seed=42
)

print(f"States: {len(ipomdp.states)}")  # 2402 (2401 + FAIL)
print(f"Actions: {len(ipomdp.actions)}")  # 2
print(f"Shield entries: {len(pp_shield)}")
```

### 3. Test Perception Bounds

Validate that the perception model's interval bounds cover empirical test frequencies:

```bash
python -m ipomdp_shielding.CaseStudies.CartPole.cartpole_model_test
```

This will:
- Split data into train/test (80/20)
- Build IMDP from training data
- Compute empirical frequencies on test data
- Report violation rate (should be ≤ α = 5%)

### 4. Run Evaluation

```python
from ipomdp_shielding.CaseStudies.CartPole import cartpole_evaluation

# Run evaluation with exact belief propagation
ipomdp, pp_shield, test_data, rtips = cartpole_evaluation()
```

## Configurable Discretization

The state space discretization is now configurable to balance precision vs. computational cost:

### Using Uniform Discretization

```python
# 5 bins per dimension → 625 states (recommended for LFP propagator)
ipomdp, pp_shield, test_data, _ = build_cartpole_ipomdp(num_bins=5)
```

### Using Non-Uniform Discretization

```python
# Higher precision on position and angle
# [n_x, n_xdot, n_theta, n_thetadot]
ipomdp, pp_shield, test_data, _ = build_cartpole_ipomdp(num_bins=[7, 5, 7, 5])
```

### Recommended Configurations

| Configuration | States | Use Case |
|--------------|--------|----------|
| `num_bins=7` | 2,401 | Too slow for LFP propagator |
| `num_bins=5` | 625 | **Recommended for LFP** |
| `num_bins=4` | 256 | Fast experiments |
| `num_bins=[7,5,7,5]` | 1,225 | Precision on position/angle |

**See [DISCRETIZATION_CONFIG.md](DISCRETIZATION_CONFIG.md) for detailed documentation.**

## Design Decisions

### State Space Discretization

Bin edges are computed from training data to cover the observed range. The number of bins per dimension can be configured to match your computational budget:

- **Default (7 bins)**: Provides good granularity but results in 2,401 states (too large for LFP propagator)
- **Recommended (5 bins)**: 625 states, feasible for most belief propagation methods
- **Non-uniform**: Use more bins on safety-critical dimensions (position, angle) vs. velocities

### Factored Perception Model

We **assume independence** between dimension errors, which:
- ✅ Reduces 7^4 × 7^4 joint confusion matrix to 4 × 7×7 matrices
- ✅ Makes belief propagation computationally tractable
- ⚠️ May underestimate correlated errors (conservative)

The factored model is constructed as:
```
P(x', ẋ', θ', θ̇' | x, ẋ, θ, θ̇) = P(x'|x) × P(ẋ'|ẋ) × P(θ'|θ) × P(θ̇'|θ̇)
```

### Empirical Dynamics

Dynamics are learned by:
1. Running 10,000 random-policy episodes in gymnasium
2. Discretizing continuous states into bins
3. Counting transitions: N[(s, a, s')]
4. Normalizing to probabilities: P(s'|s,a) = N[(s,a,s')] / Σ_s' N[(s,a,s')]

**Unobserved transitions** are filled with self-loops (conservative).

### Safety Predicate

A state is **safe** if:
- |x| ≤ 2.4 (cart position)
- |θ| ≤ 0.209 radians (pole angle ≈ 12°)

We use **one-step lookahead**: action `a` is safe from state `s` if all reachable next states are safe.

## Comparison to Taxinet

| Aspect | Taxinet | CartPole |
|--------|---------|----------|
| State Space | 2D discrete (HE, CTE) | 4D continuous → discretized |
| State Size | 21 × 21 = 441 states | 7^4 = 2,401 states |
| Data Source | Real-world sensor logs | Synthetic (gymnasium) |
| Perception | Real GPS/IMU errors | CNN estimates from frames |
| Dynamics | Analytical model | Empirical (learned) |

## References

- **CartPole-v1**: OpenAI Gymnasium classic control environment
- **IPOMDP Framework**: Badings et al., "Robust Control for Dynamical Systems with Non-Gaussian Noise via Formal Abstractions" (2022)
