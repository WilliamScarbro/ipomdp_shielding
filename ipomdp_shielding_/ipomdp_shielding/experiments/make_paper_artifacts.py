"""Paper-facing artifact generator: LaTeX-ready tables + figure copying.

Reads tidy CSV/JSON outputs from experiment tasks and emits:
- tables/*.tex snippets for the paper
- figures/*.png copied/renamed into a stable location

Usage:
    python -m ipomdp_shielding.experiments.make_paper_artifacts [--data-root DATA_ROOT] [--output-dir OUTPUT_DIR]

Default:
    --data-root ./data
    --output-dir paper_artifacts
"""

import os
import sys
import csv
import json
import shutil
import glob
from typing import List, Dict, Any, Optional


def load_csv(path: str) -> List[Dict[str, str]]:
    """Load a CSV file as list of dicts."""
    if not os.path.exists(path):
        print(f"  WARNING: {path} not found, skipping")
        return []
    with open(path, "r") as f:
        return list(csv.DictReader(f))


def load_json(path: str) -> Optional[Dict]:
    """Load a JSON file."""
    if not os.path.exists(path):
        print(f"  WARNING: {path} not found, skipping")
        return None
    with open(path, "r") as f:
        return json.load(f)


def escape_latex(s: str) -> str:
    """Escape special LaTeX characters."""
    return s.replace("_", r"\_").replace("%", r"\%").replace("&", r"\&")


def fmt_rate(val: str, ci_lo: str = "", ci_hi: str = "") -> str:
    """Format a rate as percentage with optional CI."""
    try:
        v = float(val)
        s = f"{v:.1%}"
        if ci_lo and ci_hi:
            lo = float(ci_lo)
            hi = float(ci_hi)
            s += f" [{lo:.1%}, {hi:.1%}]"
        return s
    except (ValueError, TypeError):
        return str(val)


def generate_rl_sweep_table(rows: List[Dict], output_path: str):
    """Generate LaTeX table for RL alpha/beta sweep results."""
    if not rows:
        return

    with open(output_path, "w") as f:
        f.write("% Auto-generated by make_paper_artifacts.py\n")
        f.write("\\begin{table}[ht]\n")
        f.write("\\centering\n")
        f.write("\\caption{RL Shield: Safety--Liveness Tradeoff (\\texttt{alpha} $\\times$ \\texttt{beta})}\n")
        f.write("\\label{tab:rl-sweep}\n")
        f.write("\\small\n")
        f.write("\\begin{tabular}{cccccc}\n")
        f.write("\\toprule\n")
        f.write("$\\alpha$ & $\\beta$ & Perception & Shield & Fail\\% & Stuck\\% \\\\\n")
        f.write("\\midrule\n")

        for row in sorted(rows, key=lambda r: (
            float(r.get("alpha", 0)), float(r.get("beta", 0)),
            r.get("perception", ""), r.get("shield", "")
        )):
            alpha = row.get("alpha", "")
            beta = row.get("beta", "")
            perc = escape_latex(row.get("perception", ""))
            shield = escape_latex(row.get("shield", ""))
            fail = fmt_rate(row.get("fail_rate_mean", row.get("fail_rate", "")))
            stuck = fmt_rate(row.get("stuck_rate_mean", row.get("stuck_rate", "")))
            f.write(f"{alpha} & {beta} & {perc} & {shield} & {fail} & {stuck} \\\\\n")

        f.write("\\bottomrule\n")
        f.write("\\end{tabular}\n")
        f.write("\\end{table}\n")

    print(f"  Generated {output_path}")


def generate_carr_comparison_table(rows: List[Dict], output_path: str):
    """Generate LaTeX table for Carr comparison results."""
    if not rows:
        return

    with open(output_path, "w") as f:
        f.write("% Auto-generated by make_paper_artifacts.py\n")
        f.write("\\begin{table}[ht]\n")
        f.write("\\centering\n")
        f.write("\\caption{Carr vs Lifted Shield Comparison Across Observation Uncertainty}\n")
        f.write("\\label{tab:carr-comparison}\n")
        f.write("\\small\n")
        f.write("\\begin{tabular}{ccccccc}\n")
        f.write("\\toprule\n")
        f.write("$\\alpha$ & $\\beta$ & Shield & Fail\\% & Stuck\\% & Success\\% & Avg Steps \\\\\n")
        f.write("\\midrule\n")

        for row in sorted(rows, key=lambda r: (
            float(r.get("alpha", 0)), float(r.get("beta", 0)), r.get("shield", "")
        )):
            alpha = row.get("alpha", "")
            beta = row.get("beta", "")
            shield = escape_latex(row.get("shield", ""))
            fail = fmt_rate(row.get("fail_rate", ""))
            stuck = fmt_rate(row.get("stuck_rate", ""))
            success = fmt_rate(row.get("success_rate", ""))
            avg_steps = row.get("avg_trajectory_length", "")
            try:
                avg_steps = f"{float(avg_steps):.1f}"
            except (ValueError, TypeError):
                pass
            f.write(f"{alpha} & {beta} & {shield} & {fail} & {stuck} & {success} & {avg_steps} \\\\\n")

        f.write("\\bottomrule\n")
        f.write("\\end{tabular}\n")
        f.write("\\end{table}\n")

    print(f"  Generated {output_path}")


def generate_winning_region_table(rows: List[Dict], output_path: str):
    """Generate LaTeX table for Carr winning region statistics."""
    if not rows:
        return

    with open(output_path, "w") as f:
        f.write("% Auto-generated by make_paper_artifacts.py\n")
        f.write("\\begin{table}[ht]\n")
        f.write("\\centering\n")
        f.write("\\caption{Carr Winning Region Size vs Observation Uncertainty}\n")
        f.write("\\label{tab:winning-region}\n")
        f.write("\\small\n")
        f.write("\\begin{tabular}{cccc}\n")
        f.write("\\toprule\n")
        f.write("$\\alpha$ & Total Supports & Winning Supports & Winning Fraction \\\\\n")
        f.write("\\midrule\n")

        # Deduplicate by alpha (winning region is same for all betas)
        seen_alphas = set()
        for row in sorted(rows, key=lambda r: float(r.get("alpha", 0))):
            alpha = row.get("alpha", "")
            if alpha in seen_alphas:
                continue
            seen_alphas.add(alpha)
            total = row.get("total_supports", "")
            winning = row.get("winning_supports", "")
            frac = row.get("winning_fraction", "")
            try:
                frac = f"{float(frac):.2%}"
            except (ValueError, TypeError):
                pass
            f.write(f"{alpha} & {total} & {winning} & {frac} \\\\\n")

        f.write("\\bottomrule\n")
        f.write("\\end{tabular}\n")
        f.write("\\end{table}\n")

    print(f"  Generated {output_path}")


def copy_figures(source_dirs: List[str], output_dir: str):
    """Copy all PNG figures from source directories to output."""
    os.makedirs(output_dir, exist_ok=True)
    copied = 0
    for src_dir in source_dirs:
        if not os.path.exists(src_dir):
            continue
        for png_file in glob.glob(os.path.join(src_dir, "**", "*.png"), recursive=True):
            # Create a stable name: dir_basename + filename
            parent = os.path.basename(os.path.dirname(png_file))
            fname = os.path.basename(png_file)
            dest_name = f"{parent}_{fname}" if parent != "figures" else fname
            dest = os.path.join(output_dir, dest_name)
            shutil.copy2(png_file, dest)
            copied += 1
    print(f"  Copied {copied} figure(s) to {output_dir}")


def main():
    data_root = "./data"
    output_dir = "paper_artifacts"

    # Parse args
    args = sys.argv[1:]
    i = 0
    while i < len(args):
        if args[i] == "--data-root" and i + 1 < len(args):
            data_root = args[i + 1]
            i += 2
        elif args[i] == "--output-dir" and i + 1 < len(args):
            output_dir = args[i + 1]
            i += 2
        else:
            i += 1

    tables_dir = os.path.join(output_dir, "tables")
    figures_dir = os.path.join(output_dir, "figures")
    os.makedirs(tables_dir, exist_ok=True)
    os.makedirs(figures_dir, exist_ok=True)

    print("=" * 70)
    print("PAPER ARTIFACT GENERATOR")
    print(f"Data root: {data_root}")
    print(f"Output: {output_dir}")
    print("=" * 70)

    # 1. RL alpha/beta sweep table
    print("\n--- RL Alpha/Beta Sweep ---")
    rl_sweep_csv = os.path.join(data_root, "sweep", "rl_alpha_beta_taxinet", "results_tidy.csv")
    rl_rows = load_csv(rl_sweep_csv)
    generate_rl_sweep_table(rl_rows, os.path.join(tables_dir, "rl_sweep.tex"))

    # 2. Carr comparison table
    print("\n--- Carr Comparison ---")
    carr_csv = os.path.join(data_root, "sweep", "carr_comparison", "results_tidy.csv")
    carr_rows = load_csv(carr_csv)
    generate_carr_comparison_table(carr_rows, os.path.join(tables_dir, "carr_comparison.tex"))

    # 3. Winning region table
    print("\n--- Winning Region ---")
    wr_csv = os.path.join(data_root, "sweep", "carr_comparison", "winning_region_data.csv")
    wr_rows = load_csv(wr_csv)
    generate_winning_region_table(wr_rows, os.path.join(tables_dir, "winning_region.tex"))

    # 4. Copy figures
    print("\n--- Figures ---")
    figure_sources = [
        os.path.join(data_root, "sweep", "rl_alpha_beta_taxinet", "figures"),
        os.path.join(data_root, "sweep", "carr_comparison", "figures"),
        os.path.join(data_root, "sweep", "coarseness_sensitivity", "figures"),
        os.path.join(data_root, "prelim", "rl_shield_taxinet_figures"),
    ]
    copy_figures(figure_sources, figures_dir)

    print("\n" + "=" * 70)
    print(f"DONE. Paper artifacts written to {output_dir}/")
    print(f"  tables/: LaTeX table snippets")
    print(f"  figures/: PNG figures for paper inclusion")
    print("=" * 70)


if __name__ == "__main__":
    main()
